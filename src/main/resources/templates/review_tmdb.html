<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">
	<h5 class="my-3 border-bottom pb-2">TMDB 영화/드라마/애니 검색</h5>
	<form action="/movies/search" method="get">
		<div class="mb-3">
			<label for="category" class="form-label">카테고리</label>
			<select id="category" name="category" class="form-select">
				<option th:each="category : ${categories}" 
					 th:value="${category.id}" th:text="${category.name}" 
					 th:selected="${category.id} == ${selectedCategory}">
				</option>
			</select>
		</div>	
	    <input type="hidden" name="reviewId" value="0">
		<div class="input-group mb-3">
			<input type="text" name="title" th:value="${title}" class="form-control" placeholder="영화 제목을 입력하세요">
		    <button class="btn btn-primary" type="submit">검색</button>
		</div>	    
	</form>
	
<form id="movieForm" th:action="@{/movies/select}" method="post">
  <input type="hidden" name="movieId" id="movieId">
  <input type="hidden" name="movieTitle" id="movieTitle">
  <input type="hidden" name="reviewId" id="reviewId">
  <input type="hidden" name="categoryId" id="categoryId">
  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>

	<div class="row g-3">
	    <div class="col-md-3" th:each="movie : ${movies}">
			<div class="card h-100">
			  <img th:if="${movie.posterPath != null}"
			       th:src="@{'https://image.tmdb.org/t/p/w500' + ${movie.posterPath}}"
			       class="card-img-top" alt="poster">
			  <div th:if="${movie.posterPath == null}" class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height:400px;">
			  	포스터 없음
			  </div>
				<div class="card-body">
					<h5 class="card-title" th:text="${movie.displayTitle}"></h5>
					<p class="card-text"><small class="text-muted" th:text="${movie.releaseDate}"></small></p>
				</div>
        <button type="button"
                class="btn btn-sm btn-primary select-btn"
                th:data-id="${movie.id}"
                th:data-title="${movie.displayTitle}"
                th:data-categoryId="${selectedCategory}"
                th:data-reviewId="${reviewId}">
          선택
        </button>

			</div>
	    </div>
	</div>

</div>
<script layout:fragment="script" type='text/javascript'>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("movieForm");
    const movieIdInput = document.getElementById("movieId");
    const movieTitleInput = document.getElementById("movieTitle");
    const categoryIdInput = document.getElementById("categoryId");
    const reviewIdInput = document.getElementById("reviewId");

    document.querySelectorAll(".select-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const movieId = btn.getAttribute("data-id");
        const movieTitle = btn.getAttribute("data-title");
        const categoryId = btn.getAttribute("data-categoryId");
        const reviewId = btn.getAttribute("data-reviewId");
        
        movieIdInput.value = movieId;
        movieTitleInput.value = movieTitle;
        categoryIdInput.value = categoryId;
        reviewIdInput.value = reviewId;
        form.submit(); // CSRF 토큰 포함된 폼 전송
      });
    });
  });
</script>
</html>
