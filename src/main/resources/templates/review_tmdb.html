<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">
	<h5 class="my-3 border-bottom pb-2">TMDB 영화 검색</h5>
	<form action="/movies/search" method="get" class="input-group mb-3">
	    <input type="text" name="title" class="form-control" placeholder="영화 제목을 입력하세요">
	    <button class="btn btn-primary" type="submit">검색</button>
	</form>
	
<form id="movieForm" th:action="@{/movies/select}" method="post">
  <input type="hidden" name="movieId" id="movieId">
  <input type="hidden" name="movieTitle" id="movieTitle">
  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>

	<div class="row g-3">
	    <div class="col-md-3" th:each="movie : ${movies}">
			<div class="card h-100">
			  <img th:if="${movie.posterPath != null}"
			       th:src="@{'https://image.tmdb.org/t/p/w500' + ${movie.posterPath}}"
			       class="card-img-top" alt="poster">
			  <div th:if="${movie.posterPath == null}" class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height:400px;">
			  	포스터 없음
			  </div>
				<div class="card-body">
					<h5 class="card-title" th:text="${#strings.defaultString(movie.title, '')}"></h5>
					<p class="card-text"><small class="text-muted" th:text="${movie.releaseDate}"></small></p>
				</div>
        <button type="button"
                class="btn btn-sm btn-primary select-btn"
                th:data-id="${movie.id}"
                th:data-title="${movie.title}">
          선택
        </button>

			</div>
	    </div>
	</div>

</div>
<script layout:fragment="script" type='text/javascript'>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("movieForm");
    const movieIdInput = document.getElementById("movieId");
    const movieTitleInput = document.getElementById("movieTitle");

    document.querySelectorAll(".select-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const movieId = btn.getAttribute("data-id");
        const movieTitle = btn.getAttribute("data-title");
        movieIdInput.value = movieId;
        movieTitleInput.value = movieTitle;
        form.submit(); // CSRF 토큰 포함된 폼 전송
      });
    });
  });
</script>
</html>
